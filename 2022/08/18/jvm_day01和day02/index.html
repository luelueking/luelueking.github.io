

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="Day01和Day02—手写字节码解析器 这一天其实花了我二天  废话：笔记中可能有盲区的知识点请及时去学习再来，如果你能撑过来当我没说。。。   [TOC] 前置知识不同语言能在JVM上运行的本质 核心是通过自己的编译器编译成字节码文件   认识字节码文件 除非你是大佬不然就看一下我昨天写的文章http:&#x2F;&#x2F;t.csdn.cn&#x2F;pMsWz，关于字节码的二进制，不然接下来你会懵b  Klass模型">
<meta property="og:type" content="article">
<meta property="og:title" content="不逼自己怎么知道写不出个迷你jvm之day01">
<meta property="og:url" content="http://example.com/2022/08/18/jvm_day01%E5%92%8Cday02/index.html">
<meta property="og:site_name" content="luelueking的ctf之路">
<meta property="og:description" content="Day01和Day02—手写字节码解析器 这一天其实花了我二天  废话：笔记中可能有盲区的知识点请及时去学习再来，如果你能撑过来当我没说。。。   [TOC] 前置知识不同语言能在JVM上运行的本质 核心是通过自己的编译器编译成字节码文件   认识字节码文件 除非你是大佬不然就看一下我昨天写的文章http:&#x2F;&#x2F;t.csdn.cn&#x2F;pMsWz，关于字节码的二进制，不然接下来你会懵b  Klass模型">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/2179815/1596197118079-f9d58865-ddcf-48c4-a88e-2a19073abdbc.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/2179815/1596173104706-a25dfc25-bbe2-446f-82f1-90372f73179d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/d368419624284bbc9661dfe589ba03f3.png">
<meta property="article:published_time" content="2022-08-18T15:26:59.000Z">
<meta property="article:modified_time" content="2022-08-19T06:12:21.416Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/2179815/1596197118079-f9d58865-ddcf-48c4-a88e-2a19073abdbc.png">
  
  
  
  <title>不逼自己怎么知道写不出个迷你jvm之day01 - luelueking的ctf之路</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>略略king的blogs</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="不逼自己怎么知道写不出个迷你jvm之day01"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-18 23:26" pubdate>
          2022年8月18日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          42k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          352 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">不逼自己怎么知道写不出个迷你jvm之day01</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Day01和Day02—手写字节码解析器"><a href="#Day01和Day02—手写字节码解析器" class="headerlink" title="Day01和Day02—手写字节码解析器"></a>Day01和Day02—手写字节码解析器</h1><ul>
<li><p>这一天其实花了我二天</p>
</li>
<li><p>废话：笔记中可能有盲区的知识点请及时去学习再来，如果你能撑过来当我没说。。。</p>
</li>
</ul>
<p>[TOC]</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="不同语言能在JVM上运行的本质"><a href="#不同语言能在JVM上运行的本质" class="headerlink" title="不同语言能在JVM上运行的本质"></a>不同语言能在JVM上运行的本质</h3><ul>
<li>核心是通过自己的编译器编译成字节码文件</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2179815/1596197118079-f9d58865-ddcf-48c4-a88e-2a19073abdbc.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="认识字节码文件"><a href="#认识字节码文件" class="headerlink" title="认识字节码文件"></a>认识字节码文件</h3><ul>
<li><strong>除非你是大佬不然就看一下我昨天写的文章<a target="_blank" rel="noopener" href="http://t.csdn.cn/pMsWz%EF%BC%8C%E5%85%B3%E4%BA%8E%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%EF%BC%8C%E4%B8%8D%E7%84%B6%E6%8E%A5%E4%B8%8B%E6%9D%A5%E4%BD%A0%E4%BC%9A%E6%87%B5b">http://t.csdn.cn/pMsWz，关于字节码的二进制，不然接下来你会懵b</a></strong></li>
</ul>
<h3 id="Klass模型"><a href="#Klass模型" class="headerlink" title="Klass模型"></a>Klass模型</h3><ul>
<li><p>Java的每个类，在JVM中，都有一个对应的Klass类实例与之对应，存储类的元信息如：常量池、属性信息、方法信息……</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2179815/1596173104706-a25dfc25-bbe2-446f-82f1-90372f73179d.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</li>
<li><p>从继承关系上也能看出来，类的元信息是存储在原空间的</p>
</li>
<li><p>普通的Java类在JVM中对应的是instanceKlass类的实例，再来说下它的三个字类</p>
<ul>
<li>InstanceMirrorKlass：用于表示java.lang.Class，Java代码中获取到的Class对象，实际上就是这个C++类的实例，存储在堆区，学名镜像类</li>
<li>InstanceRefKlass：用于表示java&#x2F;lang&#x2F;ref&#x2F;Reference类的子类</li>
<li>InstanceClassLoaderKlass：用于遍历某个加载器加载的类</li>
</ul>
</li>
<li><p>Java中的数组不是静态数据类型，是动态数据类型，即是运行期生成的，Java数组的元信息用ArrayKlass的子类来表示：</p>
<ul>
<li><p>TypeArrayKlass：用于表示基本类型的数组</p>
</li>
<li><p>ObjArrayKlass：用于表示引用类型的数组</p>
</li>
</ul>
</li>
</ul>
<h2 id="简陋框架搭建"><a href="#简陋框架搭建" class="headerlink" title="简陋框架搭建"></a>简陋框架搭建</h2><ul>
<li><p>首先转载一下hotspot的源码结构，因为是仿照其编写</p>
<div class="code-wrapper"><pre><code class="hljs powershell">├─agent                            Serviceability Agent的客户端实现
├─make                             用来build出HotSpot的各种配置文件
├─src                              HotSpot VM的源代码
│  ├─cpu                            CPU相关代码（汇编器、模板解释器、ad文件、部分runtime函数在这里实现）
│  ├─os                             操作系相关代码
│  ├─os_cpu                         操作系统+CPU的组合相关的代码
│  └─share                          平台无关的共通代码
│      ├─tools                        工具
│      │  ├─hsdis                      反汇编插件
│      │  ├─IdealGraphVisualizer       将server编译器的中间代码可视化的工具
│      │  ├─launcher                   启动程序“java”
│      │  ├─LogCompilation             将<span class="hljs-literal">-XX</span>:+LogCompilation输出的日志（hotspot.log）整理成更容易阅读的格式的工具
│      │  └─ProjectCreator             生成Visual Studio的project文件的工具
│      └─vm                           HotSpot VM的核心代码
│          ├─adlc                       平台描述文件（上面的cpu或os_cpu里的*.ad文件）的编译器
│          ├─asm                        汇编器接口
│          ├─c1                         client编译器（又称“C1”）
│          ├─ci                         动态编译器的公共服务/从动态编译器到VM的接口
│          ├─classfile                  类文件的处理（包括类加载和系统符号表等）
│          ├─code                       动态生成的代码的管理
│          ├─compiler                   从VM调用动态编译器的接口
│          ├─gc_implementation          <span class="hljs-built_in">GC</span>的实现
│          │  ├─concurrentMarkSweep      Concurrent Mark Sweep <span class="hljs-built_in">GC</span>的实现
│          │  ├─g1                       Garbage<span class="hljs-literal">-First</span> <span class="hljs-built_in">GC</span>的实现（不使用老的分代式<span class="hljs-built_in">GC</span>框架）
│          │  ├─parallelScavenge         ParallelScavenge <span class="hljs-built_in">GC</span>的实现（server VM默认，不使用老的分代式<span class="hljs-built_in">GC</span>框架）
│          │  ├─parNew                   ParNew <span class="hljs-built_in">GC</span>的实现
│          │  └─shared                   <span class="hljs-built_in">GC</span>的共通实现
│          ├─gc_interface               <span class="hljs-built_in">GC</span>的接口
│          ├─interpreter                解释器，包括“模板解释器”（官方版在用）和“C++解释器”（官方版不在用）
│          ├─libadt                     一些抽象数据结构
│          ├─memory                     内存管理相关（老的分代式<span class="hljs-built_in">GC</span>框架也在这里）
│          ├─oops                       HotSpot VM的对象系统的实现
│          ├─opto                       server编译器（又称“C2”或“Opto”）
│          ├─prims                      HotSpot VM的对外接口，包括部分标准库的native部分和JVMTI实现
│          ├─runtime                    运行时支持库（包括线程管理、编译器调度、锁、反射等）
│          ├─services                   主要是用来支持JMX之类的管理功能的接口
│          ├─shark                      基于LLVM的JIT编译器（官方版里没有使用）
│          └─utilities                  一些基本的工具类
└─test                             单元测试</code></pre></div>
</li>
<li><p>pom依赖</p>
<div class="code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.5.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-access<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre></div>
</li>
<li><p>HelloWorld</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.demo;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;
        System.out.println(<span class="hljs-string">&quot;Hello World!!!&quot;</span>);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>包的建立，其中vm存放jvm有关代码，jdk里面是启动类</p>
<p><img src="https://img-blog.csdnimg.cn/d368419624284bbc9661dfe589ba03f3.png" srcset="/img/loading.gif" lazyload alt="请添加图片描述"></p>
</li>
<li><p>编写启动类</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.jdk;

<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.classfile.BootClassLoader;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;
        startJVM();
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startJVM</span><span class="hljs-params">()</span> &#123; 
        BootClassLoader.loadMainClass(<span class="hljs-string">&quot;com.czh.demo.HelloWorld&quot;</span>);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>现在我们创建根类加载器，注释很详细</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.classfile;

<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.oops.InstanceKlass;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 根类加载器</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BootClassLoader</span> &#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.class&quot;</span>;

    <span class="hljs-comment">//类加载器的加载路径</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">searchPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/Users/zhchen/Downloads/My_JVM_Source/target/classes/&quot;</span>;


    <span class="hljs-comment">//用于存储该类加载器加载的所有类</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, InstanceKlass&gt; classLoaderData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();


    <span class="hljs-comment">//main函数所在的类在此保存一份引用，方便快速定位到，实际中hotspot源码并没有这么设计，我这里是为了简便</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">InstanceKlass</span> <span class="hljs-variable">mainKlass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-comment">//加载Main类通过调用LoadKlass方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstanceKlass <span class="hljs-title function_">loadMainKlass</span><span class="hljs-params">(String name)</span> &#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != mainKlass) &#123;
            <span class="hljs-keyword">return</span> mainKlass;
        &#125;

        <span class="hljs-keyword">return</span> loadKlass(name);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstanceKlass <span class="hljs-title function_">loadKlass</span><span class="hljs-params">(String name)</span> &#123;
        <span class="hljs-keyword">return</span> loadKlass(name, <span class="hljs-literal">true</span>);
    &#125;

    <span class="hljs-comment">//根据类名加载方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstanceKlass <span class="hljs-title function_">loadKlass</span><span class="hljs-params">(String name, Boolean resolve)</span> &#123;
        <span class="hljs-comment">//从classLoaderData找到方法的名字</span>
        <span class="hljs-type">InstanceKlass</span> <span class="hljs-variable">klass</span> <span class="hljs-operator">=</span> findLoadedKlass(name);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != klass) &#123;
            <span class="hljs-keyword">return</span> klass;
        &#125;

        <span class="hljs-comment">//解析字节码</span>
        klass = readAndParse(name);

        <span class="hljs-keyword">if</span> (resolve) &#123;
            resolveKlass();
        &#125;

        <span class="hljs-keyword">return</span> klass;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InstanceKlass <span class="hljs-title function_">readAndParse</span><span class="hljs-params">(String name)</span> &#123;
        <span class="hljs-type">String</span> <span class="hljs-variable">tmpName</span> <span class="hljs-operator">=</span> name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> searchPath + tmpName + SUFFIX;

        <span class="hljs-comment">// 读取字节码文件</span>
        <span class="hljs-type">byte</span>[] content = FileUtil.readBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath));

        <span class="hljs-comment">// 解析字节码文件</span>
        <span class="hljs-type">InstanceKlass</span> <span class="hljs-variable">klass</span> <span class="hljs-operator">=</span> ClassFileParser.parseClassFile(content);

        <span class="hljs-comment">// 存入</span>
        classLoaderData.put(name, klass);

        <span class="hljs-keyword">return</span> klass;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstanceKlass <span class="hljs-title function_">findLoadedKlass</span><span class="hljs-params">(String name)</span> &#123;
        <span class="hljs-keyword">return</span> classLoaderData.get(name);
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveKlass</span><span class="hljs-params">()</span> &#123;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMainKlass</span><span class="hljs-params">(InstanceKlass mainKlass)</span> &#123;
        BootClassLoader.mainKlass = mainKlass;
    &#125;
&#125;
</code></pre></div></li>
</ul>
<h2 id="oops的实体类创建"><a href="#oops的实体类创建" class="headerlink" title="oops的实体类创建"></a>oops的实体类创建</h2><ul>
<li><p>首先是Klass接口</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Klass</span> &#123;
&#125;</code></pre></div>
</li>
<li><p>InstanceKlass实体类</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstanceKlass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Klass</span>&#123;
    <span class="hljs-comment">//魔数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] magic = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];
    <span class="hljs-comment">//次版本号</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] minorVersion = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
    <span class="hljs-comment">//主版本号</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] majorVersion = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];

    <span class="hljs-comment">//常量池</span>
    <span class="hljs-keyword">private</span> ConstantPool constantPool;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> accessFlag;<span class="hljs-comment">//类访问控制权限</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> thisClass;<span class="hljs-comment">//类名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> superClass;<span class="hljs-comment">//父类名</span>

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> interfacesLength;<span class="hljs-comment">//接口数量</span>
    <span class="hljs-keyword">private</span> List&lt;InterfaceInfo&gt; interfaceInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> fieldsLength;<span class="hljs-comment">//成员属性数量</span>
    <span class="hljs-keyword">private</span> List&lt;FieldInfo&gt; fields = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> methodLength;<span class="hljs-comment">//成员方法数量</span>
    <span class="hljs-keyword">private</span> MethodInfo[] methods;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attributeLength;<span class="hljs-comment">//类属性数量</span>
    <span class="hljs-keyword">private</span> List&lt;AttributeInfo&gt; attributeInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InstanceKlass</span><span class="hljs-params">()</span> &#123;
        constantPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantPool</span>();

        constantPool.setKlass(<span class="hljs-built_in">this</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initMethodsContainer</span><span class="hljs-params">()</span> &#123;
        methods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInfo</span>[methodLength];
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;InstanceKlass&#123; &#125;&quot;</span>;
    &#125;
&#125;
</code></pre></div>
</li>
<li><p>先跳过常量池，看InterfaceInfo</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterfaceInfo</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> constantPoolIndex;

    <span class="hljs-keyword">private</span> String interfaceName;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InterfaceInfo</span><span class="hljs-params">(<span class="hljs-type">int</span> index, String name)</span> &#123;
        <span class="hljs-built_in">this</span>.constantPoolIndex = index;
        <span class="hljs-built_in">this</span>.interfaceName = name;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>FieldInfo,可以看到里面可以包含Code属性值</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FieldInfo</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> accessFlags;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nameIndex;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> descriptorIndex;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attributesCount;

    <span class="hljs-keyword">private</span> CodeAttributeInfo[] attributes;

&#125;</code></pre></div>
</li>
<li><p>CodeAttributeInfo</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.interpreter.BytecodeStream;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeAttributeInfo</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attrNameIndex;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attrLength;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxStack;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxLocals;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> codeLength;
    <span class="hljs-keyword">private</span> BytecodeStream code;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> exceptionTableLength;

    <span class="hljs-comment">// 如局部变量表、操作数栈</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attributesCount;

    <span class="hljs-keyword">private</span> Map&lt;String, AttributeInfo&gt; attributes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

&#125;</code></pre></div>
</li>
<li><p>我们将code设计成一个ByteCodeStream，方便后续的字节码指令的转换</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.interpreter;

<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.oops.CodeAttributeInfo;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.oops.MethodInfo;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BytecodeStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBytecodeStream</span> &#123;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BytecodeStream</span><span class="hljs-params">(MethodInfo belongMethod, CodeAttributeInfo belongCode)</span> &#123;
        <span class="hljs-built_in">this</span>.belongMethod = belongMethod;
        <span class="hljs-built_in">this</span>.belongCode = belongCode;
        <span class="hljs-built_in">this</span>.length = belongCode.getCodeLength();
        <span class="hljs-built_in">this</span>.index = <span class="hljs-number">0</span>;
        <span class="hljs-built_in">this</span>.codes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-built_in">this</span>.length];
    &#125;

&#125;
</code></pre></div>
</li>
<li><p>BaseByteCodeStream</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.interpreter;

<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.tools.DataTranslate;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.tools.Stream;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.oops.CodeAttributeInfo;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.oops.MethodInfo;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.nio.ByteBuffer;
<span class="hljs-keyword">import</span> java.nio.ByteOrder;


<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseBytecodeStream</span> &#123;

    <span class="hljs-keyword">protected</span> MethodInfo belongMethod;
    <span class="hljs-keyword">protected</span> CodeAttributeInfo belongCode;

    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> length;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> index;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">byte</span>[] codes;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 一次取一字节数据，自动累加</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getU1Code</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= length) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;字节码指令的索引超过了最大值&quot;</span>);
        &#125;

        <span class="hljs-keyword">return</span> Byte.toUnsignedInt(codes[index++]);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getU2Code</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= length) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;字节码指令的索引超过了最大值&quot;</span>);
        &#125;

        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];

        Stream.readU2Simple(codes, index, u2Arr);

        index += <span class="hljs-number">2</span>;

        <span class="hljs-keyword">return</span> DataTranslate.byteArrayToInt(u2Arr);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-type">short</span> <span class="hljs-title function_">getUnsignedShort</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= length) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;字节码指令的索引超过了最大值&quot;</span>);
        &#125;

        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];

        Stream.readU2Simple(codes, index, u2Arr);

        index += <span class="hljs-number">2</span>;

        <span class="hljs-keyword">return</span> (<span class="hljs-type">short</span>) DataTranslate.byteToUnsignedShort(u2Arr);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getU4Code</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= length) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;字节码指令的索引超过了最大值&quot;</span>);
        &#125;

        <span class="hljs-type">byte</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

        Stream.readU2Simple(codes, index, arr);
        index += <span class="hljs-number">4</span>;

        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(arr);
        buffer.order(ByteOrder.LITTLE_ENDIAN);

        <span class="hljs-keyword">return</span> buffer.getInt();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span> &#123;
        index = <span class="hljs-number">0</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">end</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">return</span> index &gt;= length;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inc</span><span class="hljs-params">(<span class="hljs-type">int</span> step)</span> &#123;
        index +=  step;
    &#125;
&#125;
</code></pre></div>
</li>
<li><p>AttributeInfo</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttributeInfo</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attrNameIndex;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attrLength;

    <span class="hljs-comment">// 用于存储klass的attribute</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] container;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initContainer</span><span class="hljs-params">()</span> &#123;
        container = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[attrLength];
    &#125;
&#125;</code></pre></div>
</li>
<li><p>然后我们知道在LineNumberTable和LocalVariableTable是AttributeInfo的子类</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LineNumberTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AttributeInfo</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> tableLength;
    <span class="hljs-keyword">private</span> Item[] table;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initTable</span><span class="hljs-params">()</span> &#123;
        table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Item</span>[tableLength];
    &#125;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> &#123;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> startPc;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> lineNumber;
    &#125;
&#125;</code></pre></div>

<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalVariableTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AttributeInfo</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> tableLength;
    <span class="hljs-keyword">private</span> Item[] table;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initTable</span><span class="hljs-params">()</span> &#123;
        table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Item</span>[tableLength];
    &#125;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> &#123;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> startPc;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> length;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nameIndex;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> descriptorIndex;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> index;
    &#125;

&#125;
</code></pre></div>
</li>
<li><p>MethodInfo</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.utilities.AccessFlags;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodInfo</span> &#123;

    <span class="hljs-keyword">private</span> InstanceKlass belongKlass;

    <span class="hljs-keyword">private</span> AccessFlags accessFlags;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nameIndex;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> descriptorIndex;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attributesCount;

    <span class="hljs-keyword">private</span> CodeAttributeInfo[] attributes;

    <span class="hljs-keyword">private</span> String methodName;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initAttributeContainer</span><span class="hljs-params">()</span> &#123;
        attributes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeAttributeInfo</span>[attributesCount];
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MethodInfo&#123; &quot;</span>
                + belongKlass.getConstantPool().getMethodName(nameIndex) + <span class="hljs-string">&quot;#&quot;</span>
                + belongKlass.getConstantPool().getDescriptorName(descriptorIndex)
                + <span class="hljs-string">&quot; &#125;&quot;</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>AccessFlags</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.utilities;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccessFlags</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> flag;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AccessFlags</span><span class="hljs-params">(<span class="hljs-type">int</span> flag)</span> &#123;
        <span class="hljs-built_in">this</span>.flag = flag;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStatic</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">return</span> (flag &amp; BasicType.JVM_ACC_STATIC) != <span class="hljs-number">0</span>;
    &#125;
&#125;
</code></pre></div>
</li>
<li><p>BasicType</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.utilities;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicType</span> &#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_BOOLEAN</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_CHAR</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_FLOAT</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_DOUBLE</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_BYTE</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_SHORT</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_LONG</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_OBJECT</span> <span class="hljs-operator">=</span> <span class="hljs-number">12</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_ARRAY</span> <span class="hljs-operator">=</span> <span class="hljs-number">13</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_VOID</span> <span class="hljs-operator">=</span> <span class="hljs-number">14</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_ADDRESS</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_NARROWOOP</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_METADATA</span> <span class="hljs-operator">=</span> <span class="hljs-number">17</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_NARROWKLASS</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_CONFLICT</span> <span class="hljs-operator">=</span> <span class="hljs-number">19</span>;        <span class="hljs-comment">// for stack value type with conflicting contents</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_ILLEGAL</span> <span class="hljs-operator">=</span> <span class="hljs-number">99</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">T_Throwable</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_ARRAY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;[&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_BYTE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;B&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_CHAR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;C&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;L&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_ENDCLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;;&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_ENUM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;E&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_FLOAT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;F&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_DOUBLE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;D&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_FUNC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;(&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_ENDFUNC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;)&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_INT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;I&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_LONG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;J&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_SHORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;S&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_VOID</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;V&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_SIGNATURE_BOOLEAN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Z&#x27;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0001</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_PRIVATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0002</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_PROTECTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0004</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_STATIC</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0008</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_FINAL</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0010</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_SYNCHRONIZED</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0020</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_SUPER</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0020</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_VOLATILE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0040</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_BRIDGE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0040</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_TRANSIENT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0080</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_VARARGS</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x0080</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_NATIVE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x00100</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_INTERFACE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x00200</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_ABSTRACT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x00400</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_STRICT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x00800</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_SYNTHETIC</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x001000</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_ANNOTATION</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x002000</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_ACC_ENUM</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x004000</span>;


&#125;</code></pre></div></li>
</ul>
<h2 id="字节码解析器编写"><a href="#字节码解析器编写" class="headerlink" title="字节码解析器编写"></a>字节码解析器编写</h2><ul>
<li><p>手写我们需要一个读取字节的工具类</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.tools;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Stream</span> &#123;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> from      从哪个位置开始读</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ret       传出参数</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span>          读完之后指针的位置，即开始读的位置 + 读了多少</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">readU2</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);

        <span class="hljs-keyword">return</span> from + <span class="hljs-number">2</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readU2Simple</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readSimple</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">int</span> size, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, size);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span> <span class="hljs-title function_">readU1Simple</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from)</span> &#123;
        <span class="hljs-type">byte</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1</span>];

        System.arraycopy(content, from, arr, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);

        <span class="hljs-keyword">return</span> arr[<span class="hljs-number">0</span>];
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">readU4</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);

        <span class="hljs-keyword">return</span> from + <span class="hljs-number">4</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readU4Simple</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">readU1</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);

        <span class="hljs-keyword">return</span> from + <span class="hljs-number">1</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">readU8</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>);

        <span class="hljs-keyword">return</span> from + <span class="hljs-number">8</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readU8Simple</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> from, <span class="hljs-type">byte</span>[] ret)</span> &#123;
        System.arraycopy(content, from, ret, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toHex</span><span class="hljs-params">(String s)</span> &#123;
        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; s.length(); i++) &#123;
            <span class="hljs-type">int</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) s.charAt(i);

            <span class="hljs-type">String</span> <span class="hljs-variable">s4</span> <span class="hljs-operator">=</span> Integer.toHexString(ch);
            str = str + s4;
        &#125;

        <span class="hljs-keyword">return</span> str;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">byteToUnsignedShort</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes, <span class="hljs-type">int</span> off)</span> &#123;
        <span class="hljs-type">int</span> <span class="hljs-variable">high</span> <span class="hljs-operator">=</span> bytes[off];
        <span class="hljs-type">int</span> <span class="hljs-variable">low</span> <span class="hljs-operator">=</span> bytes[off + <span class="hljs-number">1</span>];

        <span class="hljs-keyword">return</span> (high &lt;&lt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF00</span>) | (low &amp; <span class="hljs-number">0xFF</span>);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] unsignedShortToByte(<span class="hljs-type">int</span> s) &#123;
        <span class="hljs-type">byte</span>[] targets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];

        targets[<span class="hljs-number">0</span>] = (<span class="hljs-type">byte</span>) (s &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF</span>);
        targets[<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) (s &amp; <span class="hljs-number">0xFF</span>);

        <span class="hljs-keyword">return</span> targets;
    &#125;
&#125;
</code></pre></div>
</li>
<li><p>再来一个数据转换的工具</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.tools;

<span class="hljs-keyword">import</span> java.nio.ByteBuffer;
<span class="hljs-keyword">import</span> java.nio.ByteOrder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataTranslate</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] HEX_CHAR = &#123;<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>&#125;;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexFun1</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;
        <span class="hljs-type">char</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[bytes.length * <span class="hljs-number">2</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span>(<span class="hljs-type">byte</span> b : bytes) &#123;
            <span class="hljs-keyword">if</span>(b &lt; <span class="hljs-number">0</span>) &#123;
                a = <span class="hljs-number">256</span> + b;
            &#125; <span class="hljs-keyword">else</span> &#123;
                a = b;
            &#125;

            buf[index++] = HEX_CHAR[a / <span class="hljs-number">16</span>];
            buf[index++] = HEX_CHAR[a % <span class="hljs-number">16</span>];
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buf);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexFun2</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;
        <span class="hljs-type">char</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[bytes.length * <span class="hljs-number">2</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span>(<span class="hljs-type">byte</span> b : bytes) &#123;
            buf[index++] = HEX_CHAR[b &gt;&gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">0xf</span>];
            buf[index++] = HEX_CHAR[b &amp; <span class="hljs-number">0xf</span>];
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buf);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexFun3</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(bytes.length * <span class="hljs-number">2</span>);

        <span class="hljs-keyword">for</span>(<span class="hljs-type">byte</span> b : bytes) &#123;
            buf.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(b &amp; <span class="hljs-number">0xff</span>)));
        &#125;

        <span class="hljs-keyword">return</span> buf.toString();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toBytes(String str) &#123;
        <span class="hljs-keyword">if</span>(str == <span class="hljs-literal">null</span> || str.trim().equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];
        &#125;

        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[str.length() / <span class="hljs-number">2</span>];

        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; str.length() / <span class="hljs-number">2</span>; i++) &#123;
            <span class="hljs-type">String</span> <span class="hljs-variable">subStr</span> <span class="hljs-operator">=</span> str.substring(i * <span class="hljs-number">2</span>, i * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>);
            bytes[i] = (<span class="hljs-type">byte</span>) Integer.parseInt(subStr, <span class="hljs-number">16</span>);
        &#125;

        <span class="hljs-keyword">return</span> bytes;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">byteToUnsignedShort</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;
        <span class="hljs-type">int</span> <span class="hljs-variable">high</span> <span class="hljs-operator">=</span> bytes[<span class="hljs-number">0</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">low</span> <span class="hljs-operator">=</span> bytes[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">return</span> (high &lt;&lt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF00</span>) | (low &amp; <span class="hljs-number">0xFF</span>);
    &#125;


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] unsignedShortToByte(<span class="hljs-type">int</span> s) &#123;
        <span class="hljs-type">byte</span>[] targets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
        targets[<span class="hljs-number">0</span>] = (<span class="hljs-type">byte</span>) (s &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF</span>);
        targets[<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) (s &amp; <span class="hljs-number">0xFF</span>);
        <span class="hljs-keyword">return</span> targets;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * int到byte[] 由高位到低位</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> i 需要转换为byte数组的整行值。</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> byte数组</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] intToByteArray(<span class="hljs-type">int</span> i) &#123;
        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

        result[<span class="hljs-number">0</span>] = (<span class="hljs-type">byte</span>)((i &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>);
        result[<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>)((i &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>);
        result[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>)((i &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>);
        result[<span class="hljs-number">3</span>] = (<span class="hljs-type">byte</span>)(i &amp; <span class="hljs-number">0xFF</span>);

        <span class="hljs-keyword">return</span> result;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * byte[]转int</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes 需要转换成int的数组</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int值</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">byteArrayToInt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;
        <span class="hljs-type">int</span> value=<span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;
            <span class="hljs-type">int</span> shift= (<span class="hljs-number">3</span>-i) * <span class="hljs-number">8</span>;
            value +=(bytes[i] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; shift;
        &#125;

        <span class="hljs-keyword">return</span> value;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">float</span> <span class="hljs-title function_">byteToFloat</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b)</span> &#123;
        <span class="hljs-type">int</span> l;

        l = b[<span class="hljs-number">3</span>];
        l &amp;= <span class="hljs-number">0xff</span>;
        l |= ((<span class="hljs-type">long</span>) b[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">8</span>);
        l &amp;= <span class="hljs-number">0xffff</span>;
        l |= ((<span class="hljs-type">long</span>) b[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">16</span>);
        l &amp;= <span class="hljs-number">0xffffff</span>;
        l |= ((<span class="hljs-type">long</span>) b[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">24</span>);

        <span class="hljs-keyword">return</span> Float.intBitsToFloat(l);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] floatToByte(<span class="hljs-type">float</span> f) &#123;
        <span class="hljs-comment">// 把float转换为byte[]</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">fbit</span> <span class="hljs-operator">=</span> Float.floatToIntBits(f);

        <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;
            b[i] = (<span class="hljs-type">byte</span>) (fbit &gt;&gt; (<span class="hljs-number">24</span> - i * <span class="hljs-number">8</span>));
        &#125;

        <span class="hljs-comment">// 翻转数组</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> b.length;
        <span class="hljs-comment">// 建立一个与源数组元素类型相同的数组</span>
        <span class="hljs-type">byte</span>[] dest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[len];
        <span class="hljs-comment">// 为了防止修改源数组，将源数组拷贝一份副本</span>
        System.arraycopy(b, <span class="hljs-number">0</span>, dest, <span class="hljs-number">0</span>, len);
        <span class="hljs-type">byte</span> temp;
        <span class="hljs-comment">// 将顺位第i个与倒数第i个交换</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len / <span class="hljs-number">2</span>; ++i) &#123;
            temp = dest[i];
            dest[i] = dest[len - i - <span class="hljs-number">1</span>];
            dest[len - i - <span class="hljs-number">1</span>] = temp;
        &#125;
        <span class="hljs-keyword">return</span> dest;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">byteToLong</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] input, <span class="hljs-type">int</span> offset, <span class="hljs-type">boolean</span> littleEndian)</span>&#123;
        <span class="hljs-type">long</span> value=<span class="hljs-number">0</span>;
        <span class="hljs-comment">// 循环读取每个字节通过移位运算完成long的8个字节拼装</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span>  count=<span class="hljs-number">0</span>;count&lt;<span class="hljs-number">8</span>;++count)&#123;
            <span class="hljs-type">int</span> shift=(littleEndian?count:(<span class="hljs-number">7</span>-count))&lt;&lt;<span class="hljs-number">3</span>;
            value |=((<span class="hljs-type">long</span>)<span class="hljs-number">0xff</span>&lt;&lt; shift) &amp; ((<span class="hljs-type">long</span>)input[offset+count] &lt;&lt; shift);
        &#125;
        <span class="hljs-keyword">return</span> value;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">bytes2long</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bs)</span>  <span class="hljs-keyword">throws</span> Exception &#123;
        <span class="hljs-type">int</span> <span class="hljs-variable">bytes</span> <span class="hljs-operator">=</span> bs.length;
        <span class="hljs-keyword">if</span>(bytes &gt; <span class="hljs-number">1</span>) &#123;
            <span class="hljs-keyword">if</span>((bytes % <span class="hljs-number">2</span>) != <span class="hljs-number">0</span> || bytes &gt; <span class="hljs-number">8</span>) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;not support&quot;</span>);
            &#125;&#125;
        <span class="hljs-keyword">switch</span>(bytes) &#123;
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                <span class="hljs-keyword">return</span> (<span class="hljs-type">long</span>)((bs[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xff</span>));
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                <span class="hljs-keyword">return</span> (<span class="hljs-type">long</span>)((bs[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xff</span>) &lt;&lt;<span class="hljs-number">8</span> | (bs[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xff</span>));
            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
                <span class="hljs-keyword">return</span> (<span class="hljs-type">long</span>)((bs[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt;<span class="hljs-number">24</span> | (bs[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt; <span class="hljs-number">16</span> | (bs[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt;<span class="hljs-number">8</span> | (bs[<span class="hljs-number">3</span>] &amp; <span class="hljs-number">0xffL</span>));
            <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:
                <span class="hljs-keyword">return</span> (<span class="hljs-type">long</span>)((bs[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt;<span class="hljs-number">56</span> | (bs[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt; <span class="hljs-number">48</span> | (bs[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt;<span class="hljs-number">40</span> | (bs[<span class="hljs-number">3</span>] &amp; <span class="hljs-number">0xffL</span>)&lt;&lt;<span class="hljs-number">32</span> |
                        (bs[<span class="hljs-number">4</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt;<span class="hljs-number">24</span> | (bs[<span class="hljs-number">5</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt; <span class="hljs-number">16</span> | (bs[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0xffL</span>) &lt;&lt;<span class="hljs-number">8</span> | (bs[<span class="hljs-number">7</span>] &amp; <span class="hljs-number">0xffL</span>));
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;not support&quot;</span>);
        &#125;
        <span class="hljs-comment">//return 0;</span>
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 测试OK</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> littleEndian  是否是小端模式</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">bytesToDouble</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] arr, <span class="hljs-type">boolean</span> littleEndian)</span> &#123;
        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(arr,<span class="hljs-number">0</span>,<span class="hljs-number">8</span>);

        <span class="hljs-keyword">if</span> (littleEndian) &#123;
            buffer.order(ByteOrder.LITTLE_ENDIAN);
        &#125;

        <span class="hljs-keyword">return</span> buffer.getDouble();
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 测试OK</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  返回的是小端模式</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] doubleToBytes(<span class="hljs-type">double</span> d) &#123;
        <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> Double.doubleToRawLongBits(d);

        <span class="hljs-type">byte</span>[] byteRet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">8</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;
            byteRet[i] = (<span class="hljs-type">byte</span>) ((value &gt;&gt; <span class="hljs-number">8</span> * i) &amp; <span class="hljs-number">0xff</span>);
        &#125;

        <span class="hljs-keyword">return</span> byteRet;
    &#125;

&#125;
</code></pre></div>
</li>
<li><p>ConstanPool的暂时设计</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.oops;

<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;


<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantPool</span> &#123;

    <span class="hljs-comment">/*常量值基本种类*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Utf8</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Unicode</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;   <span class="hljs-comment">/* unused */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Integer</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Float</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Long</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Double</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Class</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_String</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Fieldref</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_Methodref</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_InterfaceMethodref</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_NameAndType</span> <span class="hljs-operator">=</span> <span class="hljs-number">12</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_MethodHandle</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>; <span class="hljs-comment">/* JSR 292 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_MethodType</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;   <span class="hljs-comment">/* JSR 292 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_InvokeDynamic</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span>;    <span class="hljs-comment">/* JSR 292 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">JVM_CONSTANT_ExternalMax</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span>;  <span class="hljs-comment">/* Last tag found in classfiles */</span>

    <span class="hljs-keyword">private</span> Klass klass;

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> length;

    <span class="hljs-comment">// index=&gt;type</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] tag;

    <span class="hljs-comment">// index=&gt;value</span>
    <span class="hljs-keyword">private</span> Map&lt;Integer, Object&gt; dataMap;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initContainer</span><span class="hljs-params">()</span> &#123;
        tag = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[length];
        dataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(length);
    &#125;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getClassName</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == index || index &gt; length) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         * 解释：</span>
<span class="hljs-comment">         *  1、参数index对应的是JVM_CONSTANT_Class</span>
<span class="hljs-comment">         *  2、JVM_CONSTANT_Class中的信息才是类的全限定名在常量池中的索引</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-keyword">return</span> (String) getDataMap().get(getDataMap().get(index));
    &#125;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSuperClassName</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == index || index &gt; length) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         * 解释：</span>
<span class="hljs-comment">         *  1、参数index对应的是JVM_CONSTANT_Class</span>
<span class="hljs-comment">         *  2、JVM_CONSTANT_Class中的信息才是类的全限定名在常量池中的索引</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-keyword">return</span> (String) getDataMap().get(index);
    &#125;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMethodName</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == index || index &gt; length) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        &#125;

        <span class="hljs-keyword">return</span> (String) getDataMap().get(index);
    &#125;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDescriptorName</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> &#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == index || index &gt; length) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        &#125;

        <span class="hljs-keyword">return</span> (String) getDataMap().get(index);
    &#125;

&#125;</code></pre></div>
</li>
<li><p>ClassFileParser，静下心来看，没什么难的地方</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.jvm.hotspot.src.share.vm.classfile;

<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.tools.DataTranslate;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.tools.Stream;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.interpreter.BytecodeStream;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.oops.*;
<span class="hljs-keyword">import</span> com.czh.jvm.hotspot.src.share.vm.utilities.AccessFlags;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassFileParser</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(ClassFileParser.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstanceKlass <span class="hljs-title function_">parseClassFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content)</span> &#123;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">InstanceKlass</span> <span class="hljs-variable">klass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstanceKlass</span>();
        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
        <span class="hljs-type">byte</span>[] u4Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

        <span class="hljs-comment">// 魔数 4B</span>
        Stream.readU4Simple(content, <span class="hljs-number">0</span>, klass.getMagic());
        index += <span class="hljs-number">4</span>;

        <span class="hljs-comment">// 次版本号 2B</span>
        Stream.readU2Simple(content, index, klass.getMinorVersion());
        index += <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 主版本号 2B</span>
        Stream.readU2Simple(content, index, klass.getMajorVersion());
        index += <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 常量池大小 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.getConstantPool().setLength(DataTranslate.byteToUnsignedShort(u2Arr));

        klass.getConstantPool().initContainer();

        <span class="hljs-comment">// 解析常量池 N字节</span>
        index = parseConstantPool(content, klass, index);

        <span class="hljs-comment">// 类的访问权限 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setAccessFlag(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// 类名 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setThisClass(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// 父类名 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setSuperClass(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// 实现的接口个数 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setInterfacesLength(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// 实现的接口</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != klass.getInterfacesLength()) &#123;
            logger.info(<span class="hljs-string">&quot;开始解析实现的接口信息: &quot;</span>);

            index = parseInterface(content, klass, index);
        &#125;

        <span class="hljs-comment">// 属性数量 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setFieldsLength(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// 属性</span>
        index = parseFields(content, klass, index);

        <span class="hljs-comment">// 方法数量 2B</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setMethodLength(DataTranslate.byteToUnsignedShort(u2Arr));

        klass.initMethodsContainer();

        <span class="hljs-comment">// 方法</span>
        index = parseMethods(content, klass, index);

        <span class="hljs-comment">// 属性数量</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        klass.setAttributeLength(DataTranslate.byteToUnsignedShort(u2Arr));

        logger.info(<span class="hljs-string">&quot;开始解析类的属性，数量: &quot;</span> + klass.getAttributeLength());

        <span class="hljs-comment">// 属性</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; klass.getAttributeLength(); i++) &#123;
            Stream.readU2Simple(content, index, u2Arr);

            <span class="hljs-type">String</span> <span class="hljs-variable">attrName</span> <span class="hljs-operator">=</span> (String) klass.getConstantPool().getDataMap().get(DataTranslate.byteToUnsignedShort(u2Arr));
            <span class="hljs-keyword">if</span> (attrName.equals(<span class="hljs-string">&quot;SourceFile&quot;</span>)) &#123;
                index = parseSourceFile(content, index, klass);
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;无法识别的类属性: &quot;</span> + attrName);
            &#125;
        &#125;

        <span class="hljs-keyword">return</span> klass;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseInterface</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, InstanceKlass klass, <span class="hljs-type">int</span> index)</span> &#123;
        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; klass.getInterfacesLength(); i++) &#123;
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            <span class="hljs-type">int</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);
            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> klass.getConstantPool().getClassName(val);

            <span class="hljs-type">InterfaceInfo</span> <span class="hljs-variable">interfaceInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterfaceInfo</span>(val, name);
            klass.getInterfaceInfos().add(interfaceInfo);

            logger.info(<span class="hljs-string">&quot;\t 第 &quot;</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">&quot; 个接口: &quot;</span> + name);
        &#125;

        <span class="hljs-keyword">return</span> index;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseSourceFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, <span class="hljs-type">int</span> index, InstanceKlass klass)</span> &#123;
        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
        <span class="hljs-type">byte</span>[] u4Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

        <span class="hljs-type">AttributeInfo</span> <span class="hljs-variable">attributeInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttributeInfo</span>();

        klass.getAttributeInfos().add(attributeInfo);

        <span class="hljs-comment">// name index</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        attributeInfo.setAttrNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// length</span>
        Stream.readU4Simple(content, index, u4Arr);
        index += <span class="hljs-number">4</span>;

        attributeInfo.setAttrLength(DataTranslate.byteArrayToInt(u4Arr));

        attributeInfo.initContainer();

        <span class="hljs-comment">// data</span>
        Stream.readU2Simple(content, index, attributeInfo.getContainer());
        index += <span class="hljs-number">2</span>;

        logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + klass.getAttributeInfos().size() + <span class="hljs-string">&quot; 个属性: &quot;</span> + klass.getConstantPool().getDataMap().get(attributeInfo.getAttrNameIndex())
                + <span class="hljs-string">&quot;, name index: &quot;</span> + attributeInfo.getAttrNameIndex()
                + <span class="hljs-string">&quot;, length: &quot;</span> + attributeInfo.getAttrLength()
                + <span class="hljs-string">&quot;, data: &quot;</span> + DataTranslate.byteToUnsignedShort(attributeInfo.getContainer())
                + <span class="hljs-string">&quot;( &quot;</span> + klass.getConstantPool().getDataMap().get(DataTranslate.byteToUnsignedShort(attributeInfo.getContainer())) + <span class="hljs-string">&quot; )&quot;</span>
        );

        <span class="hljs-keyword">return</span> index;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseMethods</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, InstanceKlass klass, <span class="hljs-type">int</span> index)</span> &#123;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; klass.getMethodLength(); i++) &#123;
            <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
            <span class="hljs-type">byte</span>[] u4Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

            <span class="hljs-type">MethodInfo</span> <span class="hljs-variable">methodInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInfo</span>();

            methodInfo.setBelongKlass(klass);

            klass.getMethods()[i] = methodInfo;

            <span class="hljs-comment">// access flag</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            methodInfo.setAccessFlags(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AccessFlags</span>(DataTranslate.byteToUnsignedShort(u2Arr)));

            <span class="hljs-comment">// name index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            methodInfo.setNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));
            methodInfo.setMethodName((String) methodInfo.getBelongKlass().getConstantPool().getDataMap().get(methodInfo.getNameIndex()));

            logger.info(<span class="hljs-string">&quot;解析方法: &quot;</span> + methodInfo.getMethodName());

            <span class="hljs-comment">// descriptor index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            methodInfo.setDescriptorIndex(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// attribute count</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            methodInfo.setAttributesCount(DataTranslate.byteToUnsignedShort(u2Arr));

            methodInfo.initAttributeContainer();

            logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i + <span class="hljs-string">&quot; 个方法: access flag: &quot;</span> + methodInfo.getAccessFlags()
                    + <span class="hljs-string">&quot;, name index: &quot;</span> + methodInfo.getNameIndex()
                    + <span class="hljs-string">&quot;, descriptor index: &quot;</span> + methodInfo.getDescriptorIndex()
                    + <span class="hljs-string">&quot;, attribute count: &quot;</span> + methodInfo.getAttributesCount()
            );

            <span class="hljs-comment">// 解析方法属性</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != methodInfo.getAttributesCount()) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;方法的属性不止一个&quot;</span>);
            &#125;

            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; methodInfo.getAttributesCount(); j++) &#123;
                <span class="hljs-type">CodeAttributeInfo</span> <span class="hljs-variable">attributeInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeAttributeInfo</span>();

                methodInfo.getAttributes()[j] = attributeInfo;

                <span class="hljs-comment">// attr name index</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                attributeInfo.setAttrNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));

                <span class="hljs-comment">// attr length</span>
                Stream.readU4Simple(content, index, u4Arr);
                index += <span class="hljs-number">4</span>;

                attributeInfo.setAttrLength(DataTranslate.byteArrayToInt(u4Arr));

                <span class="hljs-comment">// max stack</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                attributeInfo.setMaxStack(DataTranslate.byteToUnsignedShort(u2Arr));

                <span class="hljs-comment">// max locals</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                attributeInfo.setMaxLocals(DataTranslate.byteToUnsignedShort(u2Arr));

                <span class="hljs-comment">// code length</span>
                Stream.readU4Simple(content, index, u4Arr);
                index += <span class="hljs-number">4</span>;

                attributeInfo.setCodeLength(DataTranslate.byteArrayToInt(u4Arr));

                <span class="hljs-comment">// code</span>
                <span class="hljs-type">BytecodeStream</span> <span class="hljs-variable">bytecodeStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BytecodeStream</span>(methodInfo, attributeInfo);
                attributeInfo.setCode(bytecodeStream);

                Stream.readSimple(content, index, attributeInfo.getCodeLength(), bytecodeStream.getCodes());
                index += attributeInfo.getCodeLength();

                logger.info(<span class="hljs-string">&quot;\t\t第 &quot;</span> + j + <span class="hljs-string">&quot; 个属性: access flag: &quot;</span> + methodInfo.getAccessFlags()
                        + <span class="hljs-string">&quot;, name index: &quot;</span> + attributeInfo.getAttrNameIndex()
                        + <span class="hljs-string">&quot;, stack: &quot;</span> + attributeInfo.getMaxStack()
                        + <span class="hljs-string">&quot;, locals: &quot;</span> + attributeInfo.getMaxLocals()
                        + <span class="hljs-string">&quot;, code len: &quot;</span> + attributeInfo.getCodeLength()
                );

                <span class="hljs-comment">// exception table length</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                attributeInfo.setExceptionTableLength(DataTranslate.byteToUnsignedShort(u2Arr));

                <span class="hljs-comment">// attributes count</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                attributeInfo.setAttributesCount(DataTranslate.byteToUnsignedShort(u2Arr));

                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; attributeInfo.getAttributesCount(); k++) &#123;
                    <span class="hljs-comment">// attr name index</span>
                    Stream.readU2Simple(content, index, u2Arr);

                    <span class="hljs-type">String</span> <span class="hljs-variable">attrName</span> <span class="hljs-operator">=</span> (String) klass.getConstantPool().getDataMap().get(DataTranslate.byteToUnsignedShort(u2Arr));
                    <span class="hljs-keyword">if</span> (attrName.equals(<span class="hljs-string">&quot;LineNumberTable&quot;</span>)) &#123;
                        index = parseLineNumberTable(content, index, attrName, attributeInfo);
                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (attrName.equals(<span class="hljs-string">&quot;LocalVariableTable&quot;</span>)) &#123;
                        index = parseLocalVariableTable(content, index, attrName, attributeInfo);
                    &#125;
                &#125;
            &#125;

            <span class="hljs-comment">// 判断是不是main函数</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> (String) klass.getConstantPool().getDataMap().get(methodInfo.getNameIndex());
            <span class="hljs-type">String</span> <span class="hljs-variable">descriptorName</span> <span class="hljs-operator">=</span> (String) klass.getConstantPool().getDataMap().get(methodInfo.getDescriptorIndex());
            <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;main&quot;</span>) &amp;&amp; descriptorName.equals(<span class="hljs-string">&quot;([Ljava/lang/String;)V&quot;</span>)) &#123;
                logger.info(<span class="hljs-string">&quot;定位到main函数所在类&quot;</span>);

                BootClassLoader.setMainKlass(klass);
            &#125;
        &#125;

        <span class="hljs-keyword">return</span> index;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseLocalVariableTable</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content,</span>
<span class="hljs-params">                                               <span class="hljs-type">int</span> index,</span>
<span class="hljs-params">                                               String attrName,</span>
<span class="hljs-params">                                               CodeAttributeInfo attributeInfo)</span> &#123;
        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
        <span class="hljs-type">byte</span>[] u4Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

        <span class="hljs-type">LocalVariableTable</span> <span class="hljs-variable">localVariableTable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalVariableTable</span>();

        attributeInfo.getAttributes().put(attrName, localVariableTable);

        <span class="hljs-comment">// attr name index</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        localVariableTable.setAttrNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// attr len</span>
        Stream.readU4Simple(content, index, u4Arr);
        index += <span class="hljs-number">4</span>;

        localVariableTable.setAttrLength(DataTranslate.byteArrayToInt(u4Arr));

        <span class="hljs-comment">// table length</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        localVariableTable.setTableLength(DataTranslate.byteToUnsignedShort(u2Arr));

        localVariableTable.initTable();

        logger.info(<span class="hljs-string">&quot;\t\t\t localVariableTable: &quot;</span>
                + <span class="hljs-string">&quot;, name index: &quot;</span> + localVariableTable.getAttrNameIndex()
                + <span class="hljs-string">&quot;, attr len: &quot;</span> + localVariableTable.getAttrLength()
                + <span class="hljs-string">&quot;, table len: &quot;</span> + localVariableTable.getTableLength()
        );

        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == localVariableTable.getTableLength()) &#123;
            <span class="hljs-keyword">return</span> index;
        &#125;

        <span class="hljs-comment">// table</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; localVariableTable.getTableLength(); i++) &#123;
            LocalVariableTable.<span class="hljs-type">Item</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> localVariableTable.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Item</span>();

            localVariableTable.getTable()[i] = item;

            <span class="hljs-comment">// start pc</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            item.setStartPc(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// length</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            item.setLength(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// name index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            item.setNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// descriptor index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            item.setDescriptorIndex(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">//index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            item.setIndex(DataTranslate.byteToUnsignedShort(u2Arr));

            logger.info(<span class="hljs-string">&quot;\t\t\t\t第 &quot;</span> + i + <span class="hljs-string">&quot; 个属性: &quot;</span>
                    + <span class="hljs-string">&quot;, start pc: &quot;</span> + item.getStartPc()
                    + <span class="hljs-string">&quot;, length: &quot;</span> + item.getLength()
                    + <span class="hljs-string">&quot;, name index: &quot;</span> + item.getNameIndex()
                    + <span class="hljs-string">&quot;, descriptor index: &quot;</span> + item.getDescriptorIndex()
                    + <span class="hljs-string">&quot;, index: &quot;</span> + item.getIndex()
            );
        &#125;

        <span class="hljs-keyword">return</span> index;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseLineNumberTable</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content,</span>
<span class="hljs-params">                                            <span class="hljs-type">int</span> index,</span>
<span class="hljs-params">                                            String attrName,</span>
<span class="hljs-params">                                            CodeAttributeInfo attributeInfo)</span> &#123;
        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
        <span class="hljs-type">byte</span>[] u4Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];

        <span class="hljs-type">LineNumberTable</span> <span class="hljs-variable">lineNumberTable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LineNumberTable</span>();

        attributeInfo.getAttributes().put(attrName, lineNumberTable);

        <span class="hljs-comment">// attr name index</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        lineNumberTable.setAttrNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));

        <span class="hljs-comment">// attr len</span>
        Stream.readU4Simple(content, index, u4Arr);
        index += <span class="hljs-number">4</span>;

        lineNumberTable.setAttrLength(DataTranslate.byteArrayToInt(u4Arr));

        <span class="hljs-comment">// table length</span>
        Stream.readU2Simple(content, index, u2Arr);
        index += <span class="hljs-number">2</span>;

        lineNumberTable.setTableLength(DataTranslate.byteToUnsignedShort(u2Arr));

        lineNumberTable.initTable();

        logger.info(<span class="hljs-string">&quot;\t\t\t lineNumberTable: &quot;</span>
                + <span class="hljs-string">&quot;, name index: &quot;</span> + lineNumberTable.getAttrNameIndex()
                + <span class="hljs-string">&quot;, attr len: &quot;</span> + lineNumberTable.getAttrLength()
                + <span class="hljs-string">&quot;, table len: &quot;</span> + lineNumberTable.getTableLength()
        );

        <span class="hljs-comment">// table</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != lineNumberTable.getTableLength()) &#123;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; l &lt; lineNumberTable.getTableLength(); l++) &#123;
                LineNumberTable.<span class="hljs-type">Item</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> lineNumberTable.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Item</span>();

                lineNumberTable.getTable()[l] = item;

                <span class="hljs-comment">// start pc</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                item.setStartPc(DataTranslate.byteToUnsignedShort(u2Arr));

                <span class="hljs-comment">// line number</span>
                Stream.readU2Simple(content, index, u2Arr);
                index += <span class="hljs-number">2</span>;

                item.setLineNumber(DataTranslate.byteToUnsignedShort(u2Arr));

                logger.info(<span class="hljs-string">&quot;\t\t\t\t第 &quot;</span> + l + <span class="hljs-string">&quot; 个属性: &quot;</span>
                        + <span class="hljs-string">&quot;, start pc: &quot;</span> + item.getStartPc()
                        + <span class="hljs-string">&quot;, line number: &quot;</span> + item.getLineNumber()
                );
            &#125;
        &#125;

        <span class="hljs-keyword">return</span> index;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseFields</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, InstanceKlass klass, <span class="hljs-type">int</span> index)</span> &#123;
        logger.info(<span class="hljs-string">&quot;解析属性:&quot;</span>);

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; klass.getFieldsLength(); i++) &#123;
            <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];

            <span class="hljs-type">FieldInfo</span> <span class="hljs-variable">fieldInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FieldInfo</span>();

            klass.getFields().add(fieldInfo);

            <span class="hljs-comment">// access flag</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            fieldInfo.setAccessFlags(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// name index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            fieldInfo.setNameIndex(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// descriptor index</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            fieldInfo.setDescriptorIndex(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// attribute count</span>
            Stream.readU2Simple(content, index, u2Arr);
            index += <span class="hljs-number">2</span>;

            fieldInfo.setAttributesCount(DataTranslate.byteToUnsignedShort(u2Arr));

            <span class="hljs-comment">// attribute</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != fieldInfo.getAttributesCount()) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;属性的attribute count != 0&quot;</span>);
            &#125;

            logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i + <span class="hljs-string">&quot; 个属性: access flag: &quot;</span> + fieldInfo.getAccessFlags()
                    + <span class="hljs-string">&quot;, name index: &quot;</span> + fieldInfo.getNameIndex()
                    + <span class="hljs-string">&quot;, descriptor index: &quot;</span> + fieldInfo.getDescriptorIndex()
                    + <span class="hljs-string">&quot;, attribute count: &quot;</span> + fieldInfo.getAttributesCount()
            );
        &#125;

        <span class="hljs-keyword">return</span> index;
    &#125;


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parseConstantPool</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] content, InstanceKlass klass, <span class="hljs-type">int</span> index)</span> &#123;
        logger.info(<span class="hljs-string">&quot;解析常量池:&quot;</span>);

        <span class="hljs-type">byte</span>[] u2Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>];
        <span class="hljs-type">byte</span>[] u4Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];
        <span class="hljs-type">byte</span>[] u8Arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">8</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; klass.getConstantPool().getLength(); i++) &#123;
            <span class="hljs-comment">//先读一个tag</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">tag</span> <span class="hljs-operator">=</span> Stream.readU1Simple(content, index);
            index += <span class="hljs-number">1</span>;

            <span class="hljs-comment">//根据不同的常量类型采取不同的读取方式</span>
            <span class="hljs-comment">//TODO 暂时还没有处理Integer，Long</span>
            <span class="hljs-keyword">switch</span> (tag) &#123;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Utf8: &#123;
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Utf8;

                    <span class="hljs-comment">// 字符串长度</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// 字符串内容</span>
                    <span class="hljs-type">byte</span>[] str = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[len];

                    Stream.readSimple(content, index, len, str);
                    index += len;

                    klass.getConstantPool().getDataMap().put(i, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(str));

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: utf8，值: &quot;</span> + klass.getConstantPool().getDataMap().get(i));

                    <span class="hljs-keyword">break</span>;
                &#125;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Integer:
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Integer;

                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;程序未做处理&quot;</span>);
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Float:
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Float;

                    Stream.readU4Simple(content, index, u4Arr);
                    index += <span class="hljs-number">4</span>;

                    klass.getConstantPool().getDataMap().put(i, DataTranslate.byteToFloat(u4Arr));

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: Float，值: &quot;</span> + klass.getConstantPool().getDataMap().get(i));

                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Long:
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Long;

                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;程序未做处理&quot;</span>);
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Double:
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Double;

                    Stream.readU8Simple(content, index, u8Arr);
                    index += <span class="hljs-number">8</span>;

                    klass.getConstantPool().getDataMap().put(i, DataTranslate.bytesToDouble(u8Arr, <span class="hljs-literal">false</span>));

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: Double，值: &quot;</span> + klass.getConstantPool().getDataMap().get(i));

                    <span class="hljs-comment">/**</span>
<span class="hljs-comment">                     *  因为一个double在常量池中需要两个成员项目来存储</span>
<span class="hljs-comment">                     *  所以需要处理</span>
<span class="hljs-comment">                     */</span>
                    klass.getConstantPool().getTag()[++i] = ConstantPool.JVM_CONSTANT_Double;

                    klass.getConstantPool().getDataMap().put(i, DataTranslate.bytesToDouble(u8Arr, <span class="hljs-literal">false</span>));

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: Double，值: &quot;</span> + klass.getConstantPool().getDataMap().get(i));

                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Class: &#123;
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Class;

                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    klass.getConstantPool().getDataMap().put(i, DataTranslate.byteToUnsignedShort(u2Arr));

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: Class，值: &quot;</span> + klass.getConstantPool().getDataMap().get(i));

                    <span class="hljs-keyword">break</span>;
                &#125;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_String:
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_String;

                    <span class="hljs-comment">// Utf8_info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    klass.getConstantPool().getDataMap().put(i, DataTranslate.byteToUnsignedShort(u2Arr));

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: String，值无法获取，因为字符串的内容还未解析到&quot;</span>);

                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Fieldref: &#123;
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Fieldref;

                    <span class="hljs-comment">// Class_info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">classIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// NameAndType info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">nameAndTypeIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    klass.getConstantPool().getDataMap().put(i, classIndex &lt;&lt; <span class="hljs-number">16</span> | nameAndTypeIndex);

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: Field，值: 0x&quot;</span> + Integer.toHexString((<span class="hljs-type">int</span>) klass.getConstantPool().getDataMap().get(i)));

                    <span class="hljs-keyword">break</span>;
                &#125;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_Methodref: &#123;
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_Methodref;

                    <span class="hljs-comment">// Class_info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">classIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// NameAndType info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">nameAndTypeIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// 将classIndex与nameAndTypeIndex拼成一个，前十六位是classIndex，后十六位是nameAndTypeIndex</span>
                    klass.getConstantPool().getDataMap().put(i, classIndex &lt;&lt; <span class="hljs-number">16</span> | nameAndTypeIndex);

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: Method，值: 0x&quot;</span> + Integer.toHexString((<span class="hljs-type">int</span>) klass.getConstantPool().getDataMap().get(i)));

                    <span class="hljs-keyword">break</span>;
                &#125;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_InterfaceMethodref:
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_InterfaceMethodref;

                    <span class="hljs-comment">// Class_info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">classIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// NameAndType info</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">nameAndTypeIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// 将classIndex与nameAndTypeIndex拼成一个，前十六位是classIndex，后十六位是nameAndTypeIndex</span>
                    klass.getConstantPool().getDataMap().put(i, classIndex &lt;&lt; <span class="hljs-number">16</span> | nameAndTypeIndex);

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: InterfaceMethodref，值: 0x&quot;</span> + Integer.toHexString((<span class="hljs-type">int</span>) klass.getConstantPool().getDataMap().get(i)));

                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> ConstantPool.JVM_CONSTANT_NameAndType: &#123;
                    klass.getConstantPool().getTag()[i] = ConstantPool.JVM_CONSTANT_NameAndType;

                    <span class="hljs-comment">// 方法名</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">methodNameIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    <span class="hljs-comment">// 方法描述符</span>
                    Stream.readU2Simple(content, index, u2Arr);
                    index += <span class="hljs-number">2</span>;

                    <span class="hljs-type">int</span> <span class="hljs-variable">methodDescriptorIndex</span> <span class="hljs-operator">=</span> DataTranslate.byteToUnsignedShort(u2Arr);

                    klass.getConstantPool().getDataMap().put(i, methodNameIndex &lt;&lt; <span class="hljs-number">16</span> | methodDescriptorIndex);

                    logger.info(<span class="hljs-string">&quot;\t第 &quot;</span> + i+ <span class="hljs-string">&quot; 个: 类型: NameAndType，值: 0x&quot;</span> + Integer.toHexString((<span class="hljs-type">int</span>) klass.getConstantPool().getDataMap().get(i)));

                    <span class="hljs-keyword">break</span>;
                &#125;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;无法识别的常量池项&quot;</span>);
            &#125;
        &#125;

        <span class="hljs-keyword">return</span> index;
    &#125;
&#125;
</code></pre></div></li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li><p>改了一下啊HelloWorld；</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.czh.demo;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interface1</span>&#123;
    <span class="hljs-keyword">private</span> String string;
    <span class="hljs-keyword">private</span> Double aDouble;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;
        System.out.println(<span class="hljs-string">&quot;Hello World!!!&quot;</span>);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>运行Main类的结果</p>
<div class="code-wrapper"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>解析常量池:
<span class="hljs-bullet">- 	</span>第 1 个: 类型: Method，值: 0x60019
<span class="hljs-bullet">- 	</span>第 2 个: 类型: Field，值: 0x1a001b
<span class="hljs-bullet">- 	</span>第 3 个: 类型: String，值无法获取，因为字符串的内容还未解析到
<span class="hljs-bullet">- 	</span>第 4 个: 类型: Method，值: 0x1d001e
<span class="hljs-bullet">- 	</span>第 5 个: 类型: Class，值: 31
<span class="hljs-bullet">- 	</span>第 6 个: 类型: Class，值: 32
<span class="hljs-bullet">- 	</span>第 7 个: 类型: Class，值: 33
<span class="hljs-bullet">- 	</span>第 8 个: 类型: utf8，值: string
<span class="hljs-bullet">- 	</span>第 9 个: 类型: utf8，值: Ljava/lang/String;
<span class="hljs-bullet">- 	</span>第 10 个: 类型: utf8，值: aDouble
<span class="hljs-bullet">- 	</span>第 11 个: 类型: utf8，值: Ljava/lang/Double;
<span class="hljs-bullet">- 	</span>第 12 个: 类型: utf8，值: &lt;init&gt;
<span class="hljs-bullet">- 	</span>第 13 个: 类型: utf8，值: ()V
<span class="hljs-bullet">- 	</span>第 14 个: 类型: utf8，值: Code
<span class="hljs-bullet">- 	</span>第 15 个: 类型: utf8，值: LineNumberTable
<span class="hljs-bullet">- 	</span>第 16 个: 类型: utf8，值: LocalVariableTable
<span class="hljs-bullet">- 	</span>第 17 个: 类型: utf8，值: this
<span class="hljs-bullet">- 	</span>第 18 个: 类型: utf8，值: Lcom/czh/demo/HelloWorld;
<span class="hljs-bullet">- 	</span>第 19 个: 类型: utf8，值: main
<span class="hljs-bullet">- 	</span>第 20 个: 类型: utf8，值: ([Ljava/lang/String;)V
<span class="hljs-bullet">- 	</span>第 21 个: 类型: utf8，值: args
<span class="hljs-bullet">- 	</span>第 22 个: 类型: utf8，值: [Ljava/lang/String;
<span class="hljs-bullet">- 	</span>第 23 个: 类型: utf8，值: SourceFile
<span class="hljs-bullet">- 	</span>第 24 个: 类型: utf8，值: HelloWorld.java
<span class="hljs-bullet">- 	</span>第 25 个: 类型: NameAndType，值: 0xc000d
<span class="hljs-bullet">- 	</span>第 26 个: 类型: Class，值: 34
<span class="hljs-bullet">- 	</span>第 27 个: 类型: NameAndType，值: 0x230024
<span class="hljs-bullet">- 	</span>第 28 个: 类型: utf8，值: Hello World!!!
<span class="hljs-bullet">- 	</span>第 29 个: 类型: Class，值: 37
<span class="hljs-bullet">- 	</span>第 30 个: 类型: NameAndType，值: 0x260027
<span class="hljs-bullet">- 	</span>第 31 个: 类型: utf8，值: com/czh/demo/HelloWorld
<span class="hljs-bullet">- 	</span>第 32 个: 类型: utf8，值: java/lang/Object
<span class="hljs-bullet">- 	</span>第 33 个: 类型: utf8，值: com/czh/demo/Interface1
<span class="hljs-bullet">- 	</span>第 34 个: 类型: utf8，值: java/lang/System
<span class="hljs-bullet">- 	</span>第 35 个: 类型: utf8，值: out
<span class="hljs-bullet">- 	</span>第 36 个: 类型: utf8，值: Ljava/io/PrintStream;
<span class="hljs-bullet">- 	</span>第 37 个: 类型: utf8，值: java/io/PrintStream
<span class="hljs-bullet">- 	</span>第 38 个: 类型: utf8，值: println
<span class="hljs-bullet">- 	</span>第 39 个: 类型: utf8，值: (Ljava/lang/String;)V
<span class="hljs-bullet">- </span>开始解析实现的接口信息:
<span class="hljs-bullet">- 	 </span>第 1 个接口: com/czh/demo/Interface1
<span class="hljs-bullet">- </span>解析属性:
<span class="hljs-bullet">- 	</span>第 0 个属性: access flag: 2, name index: 8, descriptor index: 9, attribute count: 0
<span class="hljs-bullet">- 	</span>第 1 个属性: access flag: 2, name index: 10, descriptor index: 11, attribute count: 0
<span class="hljs-bullet">- </span>解析方法: &lt;init&gt;
<span class="hljs-bullet">- 	</span>第 0 个方法: access flag: AccessFlags(flag=1), name index: 12, descriptor index: 13, attribute count: 1
<span class="hljs-bullet">- 		</span>第 0 个属性: access flag: AccessFlags(flag=1), name index: 14, stack: 1, locals: 1, code len: 5
<span class="hljs-bullet">- 			 </span>lineNumberTable: , name index: 15, attr len: 6, table len: 1
<span class="hljs-bullet">- 				</span>第 0 个属性: , start pc: 0, line number: 3
<span class="hljs-bullet">- 			 </span>localVariableTable: , name index: 16, attr len: 12, table len: 1
<span class="hljs-bullet">- 				</span>第 0 个属性: , start pc: 0, length: 5, name index: 17, descriptor index: 18, index: 0
<span class="hljs-bullet">- </span>解析方法: main
<span class="hljs-bullet">- 	</span>第 1 个方法: access flag: AccessFlags(flag=9), name index: 19, descriptor index: 20, attribute count: 1
<span class="hljs-bullet">- 		</span>第 0 个属性: access flag: AccessFlags(flag=9), name index: 14, stack: 2, locals: 1, code len: 9
<span class="hljs-bullet">- 			 </span>lineNumberTable: , name index: 15, attr len: 10, table len: 2
<span class="hljs-bullet">- 				</span>第 0 个属性: , start pc: 0, line number: 7
<span class="hljs-bullet">- 				</span>第 1 个属性: , start pc: 8, line number: 8
<span class="hljs-bullet">- 			 </span>localVariableTable: , name index: 16, attr len: 12, table len: 1
<span class="hljs-bullet">- 				</span>第 0 个属性: , start pc: 0, length: 9, name index: 21, descriptor index: 22, index: 0
<span class="hljs-bullet">- </span>定位到main函数所在类
<span class="hljs-bullet">- </span>开始解析类的属性，数量: 1
<span class="hljs-bullet">- 	</span>第 1 个属性: SourceFile, name index: 23, length: 2, data: 24( HelloWorld.java )

Process finished with exit code 0
</code></pre></div></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%89%8B%E5%86%99jvm/" class="category-chain-item">手写jvm</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>不逼自己怎么知道写不出个迷你jvm之day01</div>
      <div>http://example.com/2022/08/18/jvm_day01和day02/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年8月18日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/18/jvm_day01/" title="不逼自己怎么知道写不出个迷你jvm之day01">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">不逼自己怎么知道写不出个迷你jvm之day01</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/17/spring_day05/" title="暑假最后几天！肝爆（手写）一个Spring之Day5">
                        <span class="hidden-mobile">暑假最后几天！肝爆（手写）一个Spring之Day5</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script type="text/javascript">
        var disqus_config = function() {
          this.page.url = 'http://example.com/2022/08/18/jvm_day01%E5%92%8Cday02/';
          this.page.identifier = '/2022/08/18/jvm_day01%E5%92%8Cday02/';
        };
        Fluid.utils.loadComments('#disqus_thread', function() {
          var d = document, s = d.createElement('script');
          s.src = '//' + 'fluid' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
